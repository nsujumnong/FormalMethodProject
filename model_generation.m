% this code is based on generate_computed_torque.m by Yan Wang

% syms q1(t) q2(t) q3(t) q4(t) q5(t) q6(t) q7(t);
% syms dq1(t) dq2(t) dq3(t) dq4(t) dq5(t) dq6(t) dq7(t);
% syms ddq1(t) ddq2(t) ddq3(t) ddq4(t) ddq5(t) ddq6(t) ddq7(t);

syms q1 q2 q3 q4 q5 q6 q7 real;
syms dq1 dq2 dq3 dq4 dq5 dq6 dq7 real;
syms ddq1 ddq2 ddq3 ddq4 ddq5 ddq6 ddq7 real;

% original one
A = h_b;
%A = subs(A, [q1 q2 q3 q4 q5 q6 q7], [q1(t) q2(t) q3(t) q4(t) q5(t) q6(t) q7(t)]);

%%

% vpa(A,4)
% A = [
% [ ddq2*sin(q2)*sin(q3) - 1.0*ddq3*cos(q2)*cos(q3) - 1.0*ddq2*cos(q2)*cos(q3) + ddq3*sin(q2)*sin(q3) + dq2^2*cos(q2)*sin(q3) + dq2^2*cos(q3)*sin(q2) + dq3^2*cos(q2)*sin(q3) + dq3^2*cos(q3)*sin(q2) + 2.0*dq2*dq3*cos(q2)*sin(q3) + 2.0*dq2*dq3*cos(q3)*sin(q2), 2.0*dq1*dq2 + 2.0*dq1*dq3 - 4.0*dq1*dq2*cos(q2)^2 - 4.0*dq1*dq2*cos(q3)^2 - 4.0*dq1*dq3*cos(q2)^2 - 4.0*dq1*dq3*cos(q3)^2 - 2.0*ddq1*cos(q2)*sin(q2) - 2.0*ddq1*cos(q3)*sin(q3) + 8.0*dq1*dq2*cos(q2)^2*cos(q3)^2 + 8.0*dq1*dq3*cos(q2)^2*cos(q3)^2 + 4.0*ddq1*cos(q2)*cos(q3)^2*sin(q2) + 4.0*ddq1*cos(q2)^2*cos(q3)*sin(q3) - 8.0*dq1*dq2*cos(q2)*cos(q3)*sin(q2)*sin(q3) - 8.0*dq1*dq3*cos(q2)*cos(q3)*sin(q2)*sin(q3), dq2^2*sin(q2)*sin(q3) - 1.0*ddq2*cos(q3)*sin(q2) - 1.0*ddq3*cos(q2)*sin(q3) - 1.0*ddq3*cos(q3)*sin(q2) - 1.0*dq2^2*cos(q2)*cos(q3) - 1.0*dq3^2*cos(q2)*cos(q3) - 1.0*ddq2*cos(q2)*sin(q3) + dq3^2*sin(q2)*sin(q3) - 2.0*dq2*dq3*cos(q2)*cos(q3) + 2.0*dq2*dq3*sin(q2)*sin(q3), 0.73*ddq1 - 0.558*ddq1*sin(q3) - 0.73*ddq1*cos(q2)^2 - 0.73*ddq1*cos(q3)^2 + 1.46*ddq1*cos(q2)^2*cos(q3)^2 + 0.558*ddq1*cos(q2)^2*sin(q3) - 0.558*dq1*dq2*cos(q3) - 0.558*dq1*dq3*cos(q3) + 1.116*dq1*dq2*cos(q2)^2*cos(q3) + 0.558*dq1*dq3*cos(q2)^2*cos(q3) + 0.558*ddq1*cos(q2)*cos(q3)*sin(q2) + 1.46*dq1*dq2*cos(q2)*sin(q2) + 1.46*dq1*dq3*cos(q2)*sin(q2) + 1.46*dq1*dq2*cos(q3)*sin(q3) + 1.46*dq1*dq3*cos(q3)*sin(q3) - 2.92*dq1*dq2*cos(q2)*cos(q3)^2*sin(q2) - 2.92*dq1*dq2*cos(q2)^2*cos(q3)*sin(q3) - 2.92*dq1*dq3*cos(q2)*cos(q3)^2*sin(q2) - 2.92*dq1*dq3*cos(q2)^2*cos(q3)*sin(q3) - 1.46*ddq1*cos(q2)*cos(q3)*sin(q2)*sin(q3) - 1.116*dq1*dq2*cos(q2)*sin(q2)*sin(q3) - 0.558*dq1*dq3*cos(q2)*sin(q2)*sin(q3), 2.0*dq1*dq2 - 4.0*dq1*dq2*cos(q2)^2 - 2.0*ddq1*cos(q2)*sin(q2), sin(q2)*dq2^2 - 1.0*ddq2*cos(q2), ddq1 - 1.0*ddq1*cos(q2)^2 - 1.0*ddq1*cos(q3)^2 + 2.0*ddq1*cos(q2)^2*cos(q3)^2 + 2.0*dq1*dq2*cos(q2)*sin(q2) + 2.0*dq1*dq3*cos(q2)*sin(q2) + 2.0*dq1*dq2*cos(q3)*sin(q3) + 2.0*dq1*dq3*cos(q3)*sin(q3) - 4.0*dq1*dq2*cos(q2)*cos(q3)^2*sin(q2) - 4.0*dq1*dq2*cos(q2)^2*cos(q3)*sin(q3) - 4.0*dq1*dq3*cos(q2)*cos(q3)^2*sin(q2) - 4.0*dq1*dq3*cos(q2)^2*cos(q3)*sin(q3) - 2.0*ddq1*cos(q2)*cos(q3)*sin(q2)*sin(q3), cos(q2)*dq2^2 + ddq2*sin(q2), ddq1 - 1.0*ddq1*cos(q2)^2 + 2.0*dq1*dq2*cos(q2)*sin(q2),           0, 0.558*dq1*dq2*sin(q3) - 0.73*dq1*dq3 - 0.558*ddq1*cos(q3) - 0.73*dq1*dq2 + 0.558*dq1*dq3*sin(q3) + 1.46*dq1*dq2*cos(q2)^2 + 1.46*dq1*dq2*cos(q3)^2 + 1.46*dq1*dq3*cos(q2)^2 + 1.46*dq1*dq3*cos(q3)^2 + 0.73*ddq1*cos(q2)*sin(q2) + 0.73*ddq1*cos(q3)*sin(q3) + 0.558*ddq1*cos(q2)^2*cos(q3) - 1.116*dq1*dq2*cos(q2)^2*sin(q3) - 0.558*dq1*dq3*cos(q2)^2*sin(q3) - 0.558*ddq1*cos(q2)*sin(q2)*sin(q3) - 2.92*dq1*dq2*cos(q2)^2*cos(q3)^2 - 2.92*dq1*dq3*cos(q2)^2*cos(q3)^2 - 1.46*ddq1*cos(q2)*cos(q3)^2*sin(q2) - 1.46*ddq1*cos(q2)^2*cos(q3)*sin(q3) - 1.116*dq1*dq2*cos(q2)*cos(q3)*sin(q2) - 0.558*dq1*dq3*cos(q2)*cos(q3)*sin(q2) + 2.92*dq1*dq2*cos(q2)*cos(q3)*sin(q2)*sin(q3) + 2.92*dq1*dq3*cos(q2)*cos(q3)*sin(q2)*sin(q3),   0,   0, dq1,    0, ddq1*cos(q2)^2 - 2.0*dq1*dq2*cos(q2)*sin(q2),   0,   0, 1.0, 1.116*dq1*dq2*cos(q2)^2 - 0.558*dq1*dq2 + 0.558*ddq1*cos(q2)*sin(q2), 0.558*ddq1 - 0.558*ddq1*cos(q2)^2 + 1.116*dq1*dq2*cos(q2)*sin(q2),         0, sign(dq1),         0];...
% [                                                                                                                                                                                                               ddq1*sin(q2)*sin(q3) - 1.0*ddq1*cos(q2)*cos(q3),                                                                                                                                                                                                                                                                                         2.0*dq1^2*cos(q2)^2 + 2.0*dq1^2*cos(q3)^2 - 1.0*dq1^2 - 4.0*dq1^2*cos(q2)^2*cos(q3)^2 + 4.0*dq1^2*cos(q2)*cos(q3)*sin(q2)*sin(q3),                                                                                                                                                                                                                         - 1.0*ddq1*cos(q2)*sin(q3) - 1.0*ddq1*cos(q3)*sin(q2),                                                                                                                                                                                                                                                                                                                              0.73*ddq2 + 0.73*ddq3 + 0.981*cos(q2)*cos(q3) - 0.981*sin(q2)*sin(q3) - 0.558*ddq2*sin(q3) - 0.279*ddq3*sin(q3) + 0.279*dq1^2*cos(q3) - 0.279*dq3^2*cos(q3) - 0.558*dq1^2*cos(q2)^2*cos(q3) - 0.73*dq1^2*cos(q2)*sin(q2) - 0.73*dq1^2*cos(q3)*sin(q3) - 0.558*dq2*dq3*cos(q3) + 1.46*dq1^2*cos(q2)*cos(q3)^2*sin(q2) + 1.46*dq1^2*cos(q2)^2*cos(q3)*sin(q3) + 0.558*dq1^2*cos(q2)*sin(q2)*sin(q3),                                2.0*dq1^2*cos(q2)^2 - 1.0*dq1^2,                -1.0*ddq1*cos(q2),                                                                                                                                                                                                                                                                                2.0*dq1^2*cos(q2)*cos(q3)^2*sin(q2) - 1.0*dq1^2*cos(q3)*sin(q3) - 1.0*dq1^2*cos(q2)*sin(q2) + 2.0*dq1^2*cos(q2)^2*cos(q3)*sin(q3),                 ddq1*sin(q2),                              -1.0*dq1^2*cos(q2)*sin(q2), ddq2 + ddq3,                                                                                                                                                                                                                                                                                                                                                          0.279*dq3^2*sin(q3) - 0.279*dq1^2*sin(q3) - 0.981*cos(q2)*sin(q3) - 0.981*cos(q3)*sin(q2) - 0.73*dq1^2*cos(q2)^2 - 0.73*dq1^2*cos(q3)^2 - 0.558*ddq2*cos(q3) - 0.279*ddq3*cos(q3) + 0.365*dq1^2 + 0.558*dq2*dq3*sin(q3) + 0.558*dq1^2*cos(q2)^2*sin(q3) + 1.46*dq1^2*cos(q2)^2*cos(q3)^2 + 0.558*dq1^2*cos(q2)*cos(q3)*sin(q2) - 1.46*dq1^2*cos(q2)*cos(q3)*sin(q2)*sin(q3), dq2,   0,   0, ddq2,                        dq1^2*cos(q2)*sin(q2), 1.0,   0,   0,                  0.981*cos(q2) - 0.558*dq1^2*cos(q2)^2 + 0.279*dq1^2,        - 0.558*cos(q2)*sin(q2)*dq1^2 + 0.558*ddq2 + 0.981*sin(q2),         0,         0, sign(dq2)];...
% [                                                                                                                                                                                                               ddq1*sin(q2)*sin(q3) - 1.0*ddq1*cos(q2)*cos(q3),                                                                                                                                                                                                                                                                                         2.0*dq1^2*cos(q2)^2 + 2.0*dq1^2*cos(q3)^2 - 1.0*dq1^2 - 4.0*dq1^2*cos(q2)^2*cos(q3)^2 + 4.0*dq1^2*cos(q2)*cos(q3)*sin(q2)*sin(q3),                                                                                                                                                                                                                         - 1.0*ddq1*cos(q2)*sin(q3) - 1.0*ddq1*cos(q3)*sin(q2),                                                                                                                                                                                                                                                                                                                                                                           0.73*ddq2 + 0.73*ddq3 + 0.981*cos(q2)*cos(q3) - 0.981*sin(q2)*sin(q3) - 0.279*ddq2*sin(q3) + 0.279*dq1^2*cos(q3) + 0.279*dq2^2*cos(q3) - 0.279*dq1^2*cos(q2)^2*cos(q3) - 0.73*dq1^2*cos(q2)*sin(q2) - 0.73*dq1^2*cos(q3)*sin(q3) + 1.46*dq1^2*cos(q2)*cos(q3)^2*sin(q2) + 1.46*dq1^2*cos(q2)^2*cos(q3)*sin(q3) + 0.279*dq1^2*cos(q2)*sin(q2)*sin(q3),                                                              0,                                0,                                                                                                                                                                                                                                                                                2.0*dq1^2*cos(q2)*cos(q3)^2*sin(q2) - 1.0*dq1^2*cos(q3)*sin(q3) - 1.0*dq1^2*cos(q2)*sin(q2) + 2.0*dq1^2*cos(q2)^2*cos(q3)*sin(q3),                            0,                                                       0, ddq2 + ddq3,                                                                                                                                                                                                                                                                                                                                                                                                       0.365*dq1^2 - 0.279*dq2^2*sin(q3) - 0.981*cos(q2)*sin(q3) - 0.981*cos(q3)*sin(q2) - 0.73*dq1^2*cos(q2)^2 - 0.73*dq1^2*cos(q3)^2 - 0.279*ddq2*cos(q3) - 0.279*dq1^2*sin(q3) + 0.279*dq1^2*cos(q2)^2*sin(q3) + 1.46*dq1^2*cos(q2)^2*cos(q3)^2 + 0.279*dq1^2*cos(q2)*cos(q3)*sin(q2) - 1.46*dq1^2*cos(q2)*cos(q3)*sin(q2)*sin(q3),   0, dq3,   0,    0,                                            0,   0, 1.0,   0,                                                                    0,                                                                 0, sign(dq3),         0,         0]];
%param = sym("param", [size(h_b,2),1]);
param = XB1_ols;
TAU = expand(A*param);
G = subs(TAU, {dq1 dq2 dq3, ddq1 ddq2 ddq3}, {0, 0, 0, 0, 0, 0});
CF = subs(TAU, {ddq1 ddq2 ddq3}, {0, 0, 0}) - G;
M_all = TAU - G - CF;
M = equationsToMatrix(M_all, {ddq1, ddq2, ddq3});
